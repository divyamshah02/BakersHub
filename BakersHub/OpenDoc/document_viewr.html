<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document viewr</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .document-link {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: var(--border-radius-md);
        transition: background-color 0.2s ease;
        text-decoration: none;
        color: var(--gray-800);
        }

        .document-link:hover {
        background-color: var(--gray-100);
        }

        .document-link i {
        font-size: 1.5rem;
        margin-right: 1rem;
        color: var(--gray-500);
        }

        .document-card {
            border: 2px solid black; 
            border-radius: 15px;
            background-color: var(--eh-light-grey);
            cursor: pointer;
        }

        /* PDF Viewer Canvas Styling */
        #document-viewer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow-y: auto;
        max-height: 80vh; /* Restrict the height to fit within the modal */
        }

        #pdf-render {
        max-width: 100%;
        height: auto;
        border: 1px solid #ddd; /* Optional border for clarity */
        margin-top: 10px;
        }

        #pdf-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        color: black !important;
        padding: 10px;
        border-radius: 5px;
        }

        /* #pdf-controls button {
        padding: 5px 10px;
        font-size: 14px;
        border: none;
        border-radius: 3px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        } */

        #pdf-controls button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        }

        #current-page, #total-pages {
        font-weight: 800;
        color: var(--eh-blue-primary);
        }

        #page-info {
        font-weight: 700;
        color: var(--eh-dark-grey);
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>

<body>
    <div class="d-flex align-items-center py-3 px-2 mb-2 document-card"
        onclick="openDocModal(`https://morth.nic.in/sites/default/files/dd12-13_0.pdf`, 'Doc name')">
        <i class="fa fa-file-pdf fa-xl text-danger"></i>&nbsp;&nbsp;&nbsp; <u>text</u>
        
    </div>
    <!-- Document viewer modal -->
    <div class="modal fade" id="viewDocumentModal" tabindex="-1" aria-labelledby="viewDocumentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5 text-wrap text-break" id="viewDocumentModalLabel">View Document</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="document-viewer" class="viewer"></div>
                    <!-- <div id="pdf-viewer-container" class="pdf-viewer-container">
                <canvas id="pdf-renderer"></canvas>
            </div> -->
                    <!-- <iframe src="/media/uploads/suit_divyam(1).jpeg" width="100%" height="500px" id="viewDocumentModalIframe"
                style="border: none;"></iframe> -->
                </div>
                <div class="modal-footer">
                    <!-- <button class="btn btn-danger" id="viewDocumentModalDeleteBtn"><b>Delete Doc</b></button> -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function displayDocument(url) {
            console.log(url);
            const viewer = document.getElementById('document-viewer');
            
            // const downloadLink = document.getElementById('viewDocumentModalDownloadBtn');
            // downloadLink.href = url;
            // downloadLink.download = "Report.pdf";
            


            const viewerElement = document.getElementById("document-viewer");
            const existingDownloadBtn = document.getElementById("viewDocumentModalDownloadBtn");
            if (!existingDownloadBtn) {
                const modalFooter = viewerElement.closest(".modal-body").nextElementSibling; // get the sibling footer
                
                if (modalFooter && modalFooter.classList.contains("modal-footer")) {
                    // Create <a> element
                    const downloadBtn = document.createElement("a");
                    downloadBtn.className = "btn btn-primary";
                    downloadBtn.id = "viewDocumentModalDownloadBtn";
                    downloadBtn.innerHTML = "<b>Download Doc</b>";

                    // Example: set href dynamically (if you know file URL)
                    downloadBtn.href = url;
                    downloadBtn.download = "document.pdf";

                    // Append inside footer
                    modalFooter.appendChild(downloadBtn);
                }
            }

            viewer.innerHTML = ''; // Clear previous content

            // Get the file extension
            const extension = url.split('.').pop().toLowerCase();

            // Create the appropriate element based on the file type
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
                // Image
                const img = document.createElement('img');
                img.src = url;
                img.alt = "Image document";
                img.className = 'img-fluid';
                viewer.appendChild(img);
            }
            else if (extension === 'pdf') {
                // Custom PDF Viewer
                console.log('Rendering PDF:', url);

                // Create navigation controls
                const controls = document.createElement('div');
                controls.id = 'pdf-controls';
                controls.innerHTML = `
                    <button id="prev-page" class="btn btn-primary eh-btn-blue-primary-no-hover"><i class="fa fa-circle-chevron-left"></i></button>
                    <span id="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                    <button id="next-page" class="btn btn-primary eh-btn-blue-primary-no-hover"><i class="fa fa-circle-chevron-right"></i></button>
                `;
                viewer.appendChild(controls);

                // Create canvas for rendering the PDF
                const canvas = document.createElement('canvas');
                canvas.id = 'pdf-render';
                viewer.appendChild(canvas);

                // Initialize PDF.js
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                const pdfRender = canvas;
                const ctx = pdfRender.getContext('2d');
                let pdfDoc = null;
                let currentPage = 1;
                let totalPages = 0;

                // Render the current page
                function renderPage(pageNum) {
                    pdfDoc.getPage(pageNum).then((page) => {
                        const viewport = page.getViewport({ scale: 1.5 });
                        pdfRender.width = viewport.width;
                        pdfRender.height = viewport.height;

                        const renderContext = {
                            canvasContext: ctx,
                            viewport: viewport,
                        };
                        page.render(renderContext);
                        document.getElementById('current-page').textContent = pageNum;
                    });
                }

                // Load the PDF and initialize the viewer
                pdfjsLib.getDocument(url).promise.then((pdf) => {
                    pdfDoc = pdf;
                    totalPages = pdf.numPages;
                    document.getElementById('total-pages').textContent = totalPages;
                    renderPage(currentPage);
                });

                // Add event listeners for navigation
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (currentPage <= 1) return;
                    currentPage--;
                    renderPage(currentPage);
                });

                document.getElementById('next-page').addEventListener('click', () => {
                    if (currentPage >= totalPages) return;
                    currentPage++;
                    renderPage(currentPage);
                });
            }
            else if (['mp4', 'webm', 'ogg'].includes(extension)) {
                // Video
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.style.width = "100%";
                video.style.maxHeight = '500px';
                viewer.appendChild(video);
            }
            else if (['mp3', 'wav', 'ogg'].includes(extension)) {
                // Audio
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.style.width = "100%";
                audio.style.maxHeight = '500px';
                viewer.appendChild(audio);
            }
            else {
                // Unsupported file type
                viewer.innerHTML = `<p>Unsupported document type: ${extension}, Please download to view!</p>`;
            }
        }

        async function populateDocuments() {
        const container = document.getElementById("view-reports-section")
        
        let text_content = []
        let documents = []

        let is_report_uploaded = false
        if (caseData.video_url) {
            documents.push(caseData.video_url)
            text_content.push('VMER_Report.pdf')
            is_report_uploaded = true
        }
        if (caseData.report_url) {
            documents.push(caseData.report_url)
            text_content.push('Medical_Report.pdf')
            is_report_uploaded = true
        }

        if (is_report_uploaded) [
            createDocumentList(documents, text_content)
        ]
        }

        function createDocumentList(documentList, text_content, created_at='12-05-2025') {
        const container = document.getElementById('view-reports-section');

        let doc_index = 0;
        let doc_html = "";
        documentList.forEach((doc) => {
            doc_index += 1;
            let text = text_content[doc_index-1]
            // doc_path = String(doc).replace('\\', '/');
                doc_path = String(doc);
            doc_html += `<div class="d-flex align-items-center py-3 px-2 mb-2 document-card"
                                    onclick="openDocModal('${doc_path}', '${text}')">
                                    <i class="fa fa-file-pdf fa-xl text-danger"></i>&nbsp;&nbsp;&nbsp; <u>${text}</u>
                                    <div class="ms-auto"><a class="fa fa-download fa-xl mx-2 text-white" href="${doc}" download="${String(doc).replace('https://echeckup.s3.ap-south-1.amazonaws.com/test/', '')}" id="doc-${doc_index}-downloader"></a></div>
            </div>`

        });

        container.innerHTML = '';
        container.innerHTML = doc_html;

        doc_index = 0;
        documentList.forEach((doc) => {
            doc_index += 1;
            document.getElementById(`doc-${doc_index}-downloader`).addEventListener('click', (event) => {
            event.stopPropagation();
            });
        });

        }

        function openDocModal(doc_path, doc_name) {
        displayDocument(doc_path);
        document.getElementById('viewDocumentModalLabel').innerText = doc_name;
        const myModal = new bootstrap.Modal(document.getElementById('viewDocumentModal'));
        myModal.show();
        }

    </script>
</body>

</html>